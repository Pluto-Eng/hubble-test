include .env.db
export

.PHONY: help install dev build start db-up db-down db-reset db-logs lint type-check clean db-connect api-start hubble-start dev-full status

# Default target
help:
	@echo "ğŸš€ Hubble Test Local Development Environment"
	@echo ""
	@echo "ğŸ“Š Database commands:"
	@echo "  db-up      - Start PostgreSQL and pgAdmin"
	@echo "  db-down    - Stop database services"
	@echo "  db-reset   - Reset database (removes all data)"
	@echo "  db-logs    - View database logs"
	@echo "  db-connect - Connect to database with psql"
	@echo "  db-status  - Check database health"
	@echo ""
	@echo "ğŸ”§ API Development:"
	@echo "  api-start  - Start Charon API locally (separate terminal)"
	@echo "  api-test   - Test Charon API connection"
	@echo ""
	@echo "ğŸŒ Frontend Development:"
	@echo "  hubble-start - Start Hubble frontend (separate terminal)"
	@echo "  hubble-build - Build Hubble for production"
	@echo ""
	@echo "ğŸ¯ Full Development:"
	@echo "  dev-full   - Start complete development environment"
	@echo "  status     - Check status of all services"
	@echo "  stop-all   - Stop all services"
	@echo ""
	@echo "ğŸ§¹ Maintenance:"
	@echo "  clean      - Clean build artifacts"
	@echo "  install    - Install dependencies"

# Database management
db-up:
	@echo "ğŸš€ Starting database services..."
	docker-compose up -d postgres pgadmin
	@echo "â³ Waiting for database to be ready..."
	@until docker-compose exec postgres pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} 2>/dev/null; do \
		echo "   Still waiting for database..."; \
		sleep 2; \
	done
	@echo ""
	@echo "âœ… Database services started successfully!"
	@echo ""
	@echo "ğŸ“Š PostgreSQL: localhost:5432"
	@echo "   Database: ${POSTGRES_DB}"
	@echo "   User: ${POSTGRES_USER}"
	@echo "   Password: ${POSTGRES_PASSWORD}"
	@echo ""
	@echo "ğŸ”§ pgAdmin: http://localhost:5050"
	@echo "   Email: ${PGADMIN_DEFAULT_EMAIL}"
	@echo "   Password: ${PGADMIN_DEFAULT_PASSWORD}"
	@echo ""
	@echo "ğŸ¯ Next steps:"
	@echo "   1. Run 'make api-start' in a new terminal"
	@echo "   2. Run 'make hubble-start' in another terminal"

db-down:
	@echo "ğŸ›‘ Stopping database services..."
	docker-compose down -v
	@echo "âœ… Database services stopped"

db-reset:
	@echo "ğŸ”„ Resetting database..."
	make db-down
	make db-up
	@echo "âœ… Database reset complete!"

db-logs:
	docker-compose logs -f postgres

db-status:
	@echo "ğŸ” Checking database status..."
	@if docker-compose exec postgres pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} 2>/dev/null; then \
		echo "âœ… Database is ready"; \
	else \
		echo "âŒ Database is not ready"; \
	fi
	@echo ""
	@docker-compose ps

db-connect:
	@echo "ğŸ”Œ Connecting to database..."
	PGPASSWORD=${POSTGRES_PASSWORD} psql -h localhost -p 5432 -U ${POSTGRES_USER} -d ${POSTGRES_DB}

# API Development (runs charon-beta locally)
api-start:
	@echo "ğŸš€ Starting Charon API locally..."
	@echo "ğŸ“ Make sure database is running first (make db-up)"
	@echo ""
	@if ! docker-compose exec postgres pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} 2>/dev/null; then \
		echo "âŒ Database is not ready. Run 'make db-up' first."; \
		exit 1; \
	fi
	@echo "âœ… Database is ready, starting Charon API..."
	@echo "ğŸŒ API will be available at: http://localhost:3000/api/v1"
	@echo "ğŸ“š API docs will be available at: http://localhost:3000/api-docs"
	@echo ""
	cd ../../charon-beta && \
	PGHOST=localhost \
	PGDATABASE=${POSTGRES_DB} \
	PGUSER=${POSTGRES_USER} \
	PGPASSWORD=${POSTGRES_PASSWORD} \
	PGPORT=5432 \
	NODE_ENV=development \
	npm run start:dev

api-test:
	@echo "ğŸ§ª Testing Charon API connection..."
	@if curl -s http://localhost:3000/health > /dev/null; then \
		echo "âœ… Charon API is responding"; \
		curl -s http://localhost:3000/health | jq . 2>/dev/null || curl -s http://localhost:3000/health; \
	else \
		echo "âŒ Charon API is not responding"; \
		echo "   Make sure it's running with 'make api-start'"; \
	fi

# Frontend Development (Hubble)
hubble-start:
	@echo "ğŸŒ Starting Hubble frontend..."
	@echo "ğŸ“ Make sure Charon API is running first (make api-start)"
	@echo ""
	@if ! curl -s http://localhost:3000/health > /dev/null; then \
		echo "âš ï¸  Warning: Charon API might not be running"; \
		echo "   Run 'make api-start' in another terminal first"; \
		echo ""; \
	fi
	@echo "ğŸŒ Hubble will be available at: http://localhost:3001"
	@echo ""
	cd ../ && \
	NEXT_PUBLIC_API_URL=http://localhost:3000/api/v1 \
	npm run dev -- --port 3001

hubble-build:
	@echo "ğŸ—ï¸  Building Hubble for production..."
	cd ../ && \
	NEXT_PUBLIC_API_URL=http://localhost:3000/api/v1 \
	npm run build

# Full Development Environment
dev-full:
	@echo "ğŸ¯ Setting up full development environment..."
	@echo ""
	@echo "Step 1: Starting database..."
	make db-up
	@echo ""
	@echo "âœ… Database is ready!"
	@echo ""
	@echo "ğŸ¯ Development environment setup complete!"
	@echo ""
	@echo "ğŸ“‹ Next steps (run each in a separate terminal):"
	@echo "   Terminal 2: make api-start"
	@echo "   Terminal 3: make hubble-start"
	@echo ""
	@echo "ğŸŒ URLs:"
	@echo "   Hubble Frontend: http://localhost:3001"
	@echo "   Charon API: http://localhost:3000/api/v1"
	@echo "   API Docs: http://localhost:3000/api-docs"
	@echo "   pgAdmin: http://localhost:5050"
	@echo "   Database: localhost:5432"

status:
	@echo "ğŸ” Development Environment Status"
	@echo "================================"
	@echo ""
	@echo "ğŸ“Š Database:"
	@if docker-compose exec postgres pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} 2>/dev/null; then \
		echo "   âœ… PostgreSQL: Running (localhost:5432)"; \
	else \
		echo "   âŒ PostgreSQL: Not running"; \
	fi
	@if curl -s http://localhost:5050 > /dev/null 2>&1; then \
		echo "   âœ… pgAdmin: Running (http://localhost:5050)"; \
	else \
		echo "   âŒ pgAdmin: Not running"; \
	fi
	@echo ""
	@echo "ğŸ”§ API:"
	@if curl -s http://localhost:3000/health > /dev/null 2>&1; then \
		echo "   âœ… Charon API: Running (http://localhost:3000)"; \
	else \
		echo "   âŒ Charon API: Not running"; \
	fi
	@echo ""
	@echo "ğŸŒ Frontend:"
	@if curl -s http://localhost:3001 > /dev/null 2>&1; then \
		echo "   âœ… Hubble: Running (http://localhost:3001)"; \
	else \
		echo "   âŒ Hubble: Not running"; \
	fi

stop-all:
	@echo "ğŸ›‘ Stopping all services..."
	make db-down
	@echo "âœ… All services stopped"

# Maintenance
install:
	@echo "ğŸ“¦ Installing dependencies..."
	cd ../ && npm install
	cd ../../charon-beta && npm install
	@echo "âœ… Dependencies installed"

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cd ../ && rm -rf .next node_modules/.cache
	@echo "âœ… Clean complete"

